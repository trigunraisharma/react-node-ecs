name: Deploy Backend

on:
  workflow_run:
    workflows: ["Provision Infrastructure"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend   # now all commands run inside backend
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1

    steps:
      # ----------------------------
      # 1️⃣ Checkout code
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------
      # 2️⃣ Get ECR repo URL from SSM and login
      # ----------------------------
      - name: Login to ECR
        run: |
          ECR_REPO=$(aws ssm get-parameter --name "/my-react-node-app/ecr_repo_url" --query "Parameter.Value" --output text)
          echo "ECR_REPO=$ECR_REPO" >> $GITHUB_ENV
          echo "Logging in to ECR: $ECR_REPO"
          aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPO

      # ----------------------------
      # 3️⃣ Build and Push Docker image with commit SHA tag
      # ----------------------------
      - name: Build and Push Docker image
        id: build
        run: |
          IMAGE_TAG=${GITHUB_SHA:0:7}  # short commit SHA for immutable tagging
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t $ECR_REPO:$IMAGE_TAG .
          docker push $ECR_REPO:$IMAGE_TAG

      # ----------------------------
      # 4️⃣ Update ECS service with new image
      # ----------------------------
      - name: Update ECS service
        run: |
          CLUSTER=$(aws ssm get-parameter --name "/my-react-node-app/ecs_cluster" --query "Parameter.Value" --output text)
          SERVICE=$(aws ssm get-parameter --name "/my-react-node-app/ecs_service" --query "Parameter.Value" --output text)
          ECR_REPO=$(aws ssm get-parameter --name "/my-react-node-app/ecr_repo_url" --query "Parameter.Value" --output text)
          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --force-new-deployment \
            --image $ECR_REPO:$IMAGE_TAG

